import { nodeFileTrace } from "@vercel/nft";
import { relative as relativePath } from "node:path";
import { fileURLToPath } from "node:url";
import { copyFilesToFunction } from "./fs.js";
async function copyDependenciesToFunction({
  entry,
  outDir,
  includeFiles,
  excludeFiles
}) {
  const entryPath = fileURLToPath(entry);
  let base = entry;
  while (fileURLToPath(base) !== fileURLToPath(new URL("../", base))) {
    base = new URL("../", base);
  }
  const result = await nodeFileTrace([entryPath], {
    base: fileURLToPath(base)
  });
  for (const error of result.warnings) {
    if (error.message.startsWith("Failed to resolve dependency")) {
      const [, module, file] = /Cannot find module '(.+?)' loaded from (.+)/.exec(error.message);
      if (module === "@astrojs/")
        continue;
      if (entryPath === file) {
        console.warn(
          `[@astrojs/vercel] The module "${module}" couldn't be resolved. This may not be a problem, but it's worth checking.`
        );
      } else {
        console.warn(
          `[@astrojs/vercel] The module "${module}" inside the file "${file}" couldn't be resolved. This may not be a problem, but it's worth checking.`
        );
      }
    } else {
      throw error;
    }
  }
  const commonAncestor = await copyFilesToFunction(
    [...result.fileList].map((file) => new URL(file, base)).concat(includeFiles),
    outDir,
    excludeFiles
  );
  return {
    handler: relativePath(commonAncestor, entryPath)
  };
}
export {
  copyDependenciesToFunction
};
